trigger: none 

pr: none 

variables:
  vmImage: 'ubuntu-16.04'
  location: eastus
  nodeCount: 3
  nodeSize: Standard_DS2_v2
  # define 3 more variables: kv and aksPrefix in the pipeline UI definition

stages:
- stage: CreateAKSCluster
  displayName: CreateAKSCluster
  condition: and(succeeded(), eq(variables.createAksCluster, 'true'))
  jobs:
  - job: CreateAKSCluster
    pool:
      vmImage: $(vmImage)
    steps:
    - task: AzureKeyVault@1
      displayName: 'Get secrets from Key Vault'
      inputs:
        azureSubscription: keyvault
        KeyVaultName: $(kv)
        SecretsFilter: 'subscriptionId,spId,spSecret,spTenantId'
    - bash: |
        randomSuffix=$(shuf -i 1000-9999 -n 1)
        echo '##vso[task.setvariable variable=aksName]$(aksPrefix)-$randomSuffix'
      displayName: 'setup aks name'
    - task: Bash@3
      displayName: 'create rg and aks'
      inputs:
        targetType: filePath
        filePath: './create-aks-cluster.sh'
        failOnStderr: true
      env:
          LOCATION: $(location)
          NODE_COUNT: $(nodeCount)
          NODE_SIZE: $(nodeSize)
          SUBSCRIPTION_ID: $(subscriptionId)
          SP_ID: $(spId)
          SP_SECRET: $(spSecret)
          SP_TENANT_ID: $(spTenantId)
          AKS: $(aksName)
          RG: $(aksName)
- stage: AzureTests
  displayName: AzureTests
  jobs:
  - job: AzureTests
    pool:
      vmImage: $(vmImage)
    steps:
    - task: AzureKeyVault@1
      displayName: 'Get secrets from Key Vault'
      inputs:
        azureSubscription: keyvault
        KeyVaultName: $(kv)
        SecretsFilter: 'subscriptionId,spId,spSecret,spTenantId'
    - task: Bash@3
      displayName: 'test azure infra'
      inputs:
        targetType: filePath
        filePath: './test-azure-infra.sh'
        failOnStderr: true
      env:
          LOCATION: $(location)
          NODE_COUNT: $(nodeCount)
          NODE_SIZE: $(nodeSize)
          SUBSCRIPTION_ID: $(subscriptionId)
          SP_ID: $(spId)
          SP_SECRET: $(spSecret)
          SP_TENANT_ID: $(spTenantId)
          AKS: $(aks)
          RG: $(rg)
